{"version":3,"file":"Pay-CQ7G_184.js","sources":["../../src/uiux/lib/Pay.js"],"sourcesContent":["window._lib_pay=(function (){\r\n  // 过滤Url首字符\r\n  function urlFirstString(url){\r\n    if(url===''){\r\n      return ''\r\n    }\r\n    const outputString = url.slice(0, 1);\r\n    if(outputString==='/'){\r\n      return url;\r\n    }else {\r\n      return '/'+url;\r\n    }\r\n  }\r\n// Service域名\r\n  function getServiceUrl(url='') {\r\n    if(window.location.origin.indexOf('localhost')!==-1||window.location.origin.indexOf('dybzp')!==-1){\r\n      return \"http://localhost.3d66.com:8888\"+urlFirstString(url);\r\n    }\r\n    if(window.location.origin.indexOf('dev')!==-1){\r\n      return \"http://service.dev.3d66.com\"+urlFirstString(url);\r\n    }\r\n    if(window.location.origin.indexOf('test')!==-1||window.location.origin.indexOf('dybzp')!==-1){\r\n      return \"https://service_test.3d66.com\"+urlFirstString(url);\r\n    }\r\n    return \"https://service.3d66.com\"+urlFirstString(url);\r\n  }\r\n\r\n  let loadPay = null\r\n\r\n// 支付接口\r\n  function paymentFcun(params, callback ) {\r\n    $('#_qrcode').html('')\r\n    $('.pop_pay .ref .past').text('').addClass('loading').show()\r\n    let data = JSON.stringify(params);\r\n    $.ajax({\r\n      url: getServiceUrl('/payment/do_payment'),\r\n      type: 'post',\r\n      data: {data},\r\n      xhrFields: {\r\n        withCredentials: true\r\n      },\r\n      success: function(res) {\r\n        // debugger\r\n        if(res.status === 1){\r\n          switch(parseInt(params.cz_type)){\r\n            case 0:\r\n              createQrCodes(res.data.qrcode, \"wechat\");\r\n              break;\r\n            case 1:\r\n              createQrCodes(res.data, \"ali\");\r\n              break;\r\n            case 3://paypal\r\n              $('#_paypalSubmit').html(res.data.payurl);\r\n              break;\r\n            default:\r\n              //清除二维码\r\n              $('#_qrcode').empty();\r\n              //微信扫码支付二维码\r\n              createQrCodes(res.data.qrcode, \"wechat\");\r\n              break;\r\n          }\r\n\r\n          //检查支付\r\n          checkPay(res.data.jkma,params.order_type, callback, parseInt(params.cz_type));\r\n\r\n          $('.pop_pay .ref .past').removeClass(\"loading\").hide()\r\n        }else{\r\n          window.easyPop.open({type: \"toast\", content: res.msg});\r\n\r\n          // 手动刷新二维码\r\n          $('.pop_pay .ref .past').removeClass(\"loading\").html(`<p style=\"width: 100%;position: absolute;top: 50%;left: 50%;transform: translate(-50%, -50%);line-height: 20px; cursor: pointer\" id=\"_userDefine_cover\">二维码已失效<br>点击刷新</p>`).show()\r\n          $('#_userDefine_cover').one(\"click\", function () {\r\n            $('#_payBtn li.active').trigger('click'); // 刷新二维码\r\n          })\r\n        }\r\n      }\r\n    });\r\n  }\r\n//二维码\r\n  function createQrCodes(url, type) {\r\n    let DEFAULT_VERSION = \"8.0\";\r\n    let ua = navigator.userAgent.toLowerCase();\r\n    let isIE = ua.indexOf(\"msie\") > -1;\r\n    let safariVersion;\r\n    if (isIE) {\r\n      safariVersion = ua.match(/msie ([\\d.]+)/)[1];\r\n    }\r\n    //判断IE8浏览器，qrcode使用table,其他版本使用canves\r\n    //生成二维码\r\n    const $_qrcode = $('#_qrcode')\r\n    switch (type) {\r\n      case \"ali\":\r\n        $_qrcode.html('');\r\n        if(url.unionPay){ // 是否聚合支付\r\n          setTimeout(function () {\r\n            $_qrcode.qrcode({\r\n              width: 120,\r\n              height: 120,\r\n              text: url.qrcode\r\n            });\r\n          }, 100);\r\n        }else{\r\n          if (!document.getElementById(\"iframeid\")) {\r\n            $_qrcode.append(`<iframe id=\"iframeid\" src=\"${url.payurl}\" width=\"120\" height=\"120\" frameborder=\"0\" scrolling=\"no\"></iframe>`);\r\n          }\r\n        }\r\n        break;\r\n      case \"wechat\":\r\n        $_qrcode.html('');\r\n        $_qrcode.qrcode({\r\n          width: 120,\r\n          height: 120,\r\n          text: url\r\n        });\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n  }\r\n  var liuyunku = liuyunku || {};\r\n  liuyunku.getVersionId = function() {\r\n    var versionId = 0;\r\n    try {\r\n      versionId = window.external.LiuYunKuVersionId;\r\n    } catch (err) {\r\n      console.log('获取失败：' + err);\r\n    }\r\n    return Number(versionId);\r\n  };\r\n  liuyunku.paymentSuccessCallback = function(data) {\r\n    var lykApi = {\r\n      handler: typeof window.external == 'object' ? window.external : {},\r\n      paymentSuccessCallback: function(data) {\r\n        var hasErr = false, error;\r\n        try {\r\n          data = typeof data !== 'undefined' ? data : '';\r\n          this.handler.paymentSuccessCallback(data);\r\n        } catch (err) {\r\n          hasErr = true;\r\n          error = err;\r\n        }\r\n\r\n        return new Promise(function(resolve, reject) {\r\n          hasErr ? reject(error) : resolve();\r\n        });\r\n      },\r\n    };\r\n    lykApi.paymentSuccessCallback(data).catch(function(err) {\r\n      console.log('方法调用失败：' + err);\r\n    });\r\n  };\r\n  liuyunku.refAccountCallback = function() {\r\n    try {\r\n      var lykApi = {\r\n        handler: typeof window.external == 'object' ? window.external : {},\r\n        refAccountCallback: function(data) {\r\n          'refAccountCallback' in this.handler && this.handler.refAccountCallback(data);\r\n        },\r\n      };\r\n      window.external.refAccountCallback();\r\n    } catch (error) {\r\n      console.log('方法调用失败');\r\n    }\r\n  };\r\n//检查支付\r\n  function checkPay(jkma, cz_channel, callback, cz_type){\r\n\r\n    clearInterval(loadPay);\r\n    // 轮询\r\n    loadPay = setInterval(function(){\r\n\r\n      // 如果关闭弹窗，结束轮巡\r\n      if(!$(\".pop_pay\").is(':visible')){\r\n        clearInterval(loadPay);\r\n      }\r\n\r\n      $.ajax({\r\n        url: getServiceUrl('/pay/check_pay'),\r\n        type: 'post',\r\n        data:{service: \"ll.order.check\", jkma: jkma, cz_channel: cz_channel},\r\n        xhrFields: {\r\n          withCredentials: true\r\n        },\r\n        success: function(res) {\r\n          // 判断订单支付情况\r\n          if(res.status === 200){\r\n            callback()\r\n            clearInterval(loadPay);\r\n\r\n            // 判断客户端版本，调用不同的方法\r\n            var isTestEnv = window.location.origin.indexOf('test') > -1;\r\n            var minVersionId = isTestEnv ? 660 : 1409;\r\n            liuyunku.getVersionId() > minVersionId\r\n              ? liuyunku.paymentSuccessCallback(res.data)\r\n              : liuyunku.refAccountCallback();\r\n          }else if(res.status === 401){\r\n            if(cz_type !== 3){\r\n              // 二维码过期\r\n              $('.pop_pay .ref .past').html(`<p style=\"width: 100%;position: absolute;top: 50%;left: 50%;transform: translate(-50%, -50%);line-height: 20px; cursor: pointer\" id=\"_userDefine_cover\">二维码已失效<br>点击刷新</p>`).show()\r\n              $('#_userDefine_cover').one(\"click\", function () {\r\n                $('#_payBtn li.active').trigger('click'); // 刷新二维码\r\n              })\r\n              clearInterval(loadPay);\r\n            }\r\n          }\r\n        },\r\n        error: function(err){\r\n          console.log('err:',err)\r\n        }\r\n      })\r\n    },2000)\r\n  }\r\n\r\n// 切换套包的时候清除轮训\r\n  function clearTabCheckPay(){\r\n    $('.pop_pay .ref .past').hide()\r\n    clearInterval(loadPay);\r\n  }\r\n\r\n  return {\r\n    paymentFcun,\r\n    clearTabCheckPay\r\n  }\r\n})()"],"names":["urlFirstString","url","getServiceUrl","loadPay","paymentFcun","params","callback","data","res","createQrCodes","checkPay","type","ua","$_qrcode","liuyunku","versionId","err","lykApi","hasErr","error","resolve","reject","jkma","cz_channel","cz_type","isTestEnv","minVersionId","clearTabCheckPay"],"mappings":"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"}