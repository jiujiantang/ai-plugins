{"version":3,"file":"Pay-legacy-cbLIaXEj.js","sources":["../../src/uiux/lib/Pay.js"],"sourcesContent":["window._lib_pay=(function (){\r\n  // 过滤Url首字符\r\n  function urlFirstString(url){\r\n    if(url===''){\r\n      return ''\r\n    }\r\n    const outputString = url.slice(0, 1);\r\n    if(outputString==='/'){\r\n      return url;\r\n    }else {\r\n      return '/'+url;\r\n    }\r\n  }\r\n// Service域名\r\n  function getServiceUrl(url='') {\r\n    if(window.location.origin.indexOf('localhost')!==-1||window.location.origin.indexOf('dybzp')!==-1){\r\n      return \"http://localhost.3d66.com:8888\"+urlFirstString(url);\r\n    }\r\n    if(window.location.origin.indexOf('dev')!==-1){\r\n      return \"http://service.dev.3d66.com\"+urlFirstString(url);\r\n    }\r\n    if(window.location.origin.indexOf('test')!==-1||window.location.origin.indexOf('dybzp')!==-1){\r\n      return \"https://service_test.3d66.com\"+urlFirstString(url);\r\n    }\r\n    return \"https://service.3d66.com\"+urlFirstString(url);\r\n  }\r\n\r\n  let loadPay = null\r\n\r\n// 支付接口\r\n  function paymentFcun(params, callback ) {\r\n    $('#_qrcode').html('')\r\n    $('.pop_pay .ref .past').text('').addClass('loading').show()\r\n    let data = JSON.stringify(params);\r\n    $.ajax({\r\n      url: getServiceUrl('/payment/do_payment'),\r\n      type: 'post',\r\n      data: {data},\r\n      xhrFields: {\r\n        withCredentials: true\r\n      },\r\n      success: function(res) {\r\n        // debugger\r\n        if(res.status === 1){\r\n          switch(parseInt(params.cz_type)){\r\n            case 0:\r\n              createQrCodes(res.data.qrcode, \"wechat\");\r\n              break;\r\n            case 1:\r\n              createQrCodes(res.data, \"ali\");\r\n              break;\r\n            case 3://paypal\r\n              $('#_paypalSubmit').html(res.data.payurl);\r\n              break;\r\n            default:\r\n              //清除二维码\r\n              $('#_qrcode').empty();\r\n              //微信扫码支付二维码\r\n              createQrCodes(res.data.qrcode, \"wechat\");\r\n              break;\r\n          }\r\n\r\n          //检查支付\r\n          checkPay(res.data.jkma,params.order_type, callback, parseInt(params.cz_type));\r\n\r\n          $('.pop_pay .ref .past').removeClass(\"loading\").hide()\r\n        }else{\r\n          window.easyPop.open({type: \"toast\", content: res.msg});\r\n\r\n          // 手动刷新二维码\r\n          $('.pop_pay .ref .past').removeClass(\"loading\").html(`<p style=\"width: 100%;position: absolute;top: 50%;left: 50%;transform: translate(-50%, -50%);line-height: 20px; cursor: pointer\" id=\"_userDefine_cover\">二维码已失效<br>点击刷新</p>`).show()\r\n          $('#_userDefine_cover').one(\"click\", function () {\r\n            $('#_payBtn li.active').trigger('click'); // 刷新二维码\r\n          })\r\n        }\r\n      }\r\n    });\r\n  }\r\n//二维码\r\n  function createQrCodes(url, type) {\r\n    let DEFAULT_VERSION = \"8.0\";\r\n    let ua = navigator.userAgent.toLowerCase();\r\n    let isIE = ua.indexOf(\"msie\") > -1;\r\n    let safariVersion;\r\n    if (isIE) {\r\n      safariVersion = ua.match(/msie ([\\d.]+)/)[1];\r\n    }\r\n    //判断IE8浏览器，qrcode使用table,其他版本使用canves\r\n    //生成二维码\r\n    const $_qrcode = $('#_qrcode')\r\n    switch (type) {\r\n      case \"ali\":\r\n        $_qrcode.html('');\r\n        if(url.unionPay){ // 是否聚合支付\r\n          setTimeout(function () {\r\n            $_qrcode.qrcode({\r\n              width: 120,\r\n              height: 120,\r\n              text: url.qrcode\r\n            });\r\n          }, 100);\r\n        }else{\r\n          if (!document.getElementById(\"iframeid\")) {\r\n            $_qrcode.append(`<iframe id=\"iframeid\" src=\"${url.payurl}\" width=\"120\" height=\"120\" frameborder=\"0\" scrolling=\"no\"></iframe>`);\r\n          }\r\n        }\r\n        break;\r\n      case \"wechat\":\r\n        $_qrcode.html('');\r\n        $_qrcode.qrcode({\r\n          width: 120,\r\n          height: 120,\r\n          text: url\r\n        });\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n  }\r\n  var liuyunku = liuyunku || {};\r\n  liuyunku.getVersionId = function() {\r\n    var versionId = 0;\r\n    try {\r\n      versionId = window.external.LiuYunKuVersionId;\r\n    } catch (err) {\r\n      console.log('获取失败：' + err);\r\n    }\r\n    return Number(versionId);\r\n  };\r\n  liuyunku.paymentSuccessCallback = function(data) {\r\n    var lykApi = {\r\n      handler: typeof window.external == 'object' ? window.external : {},\r\n      paymentSuccessCallback: function(data) {\r\n        var hasErr = false, error;\r\n        try {\r\n          data = typeof data !== 'undefined' ? data : '';\r\n          this.handler.paymentSuccessCallback(data);\r\n        } catch (err) {\r\n          hasErr = true;\r\n          error = err;\r\n        }\r\n\r\n        return new Promise(function(resolve, reject) {\r\n          hasErr ? reject(error) : resolve();\r\n        });\r\n      },\r\n    };\r\n    lykApi.paymentSuccessCallback(data).catch(function(err) {\r\n      console.log('方法调用失败：' + err);\r\n    });\r\n  };\r\n  liuyunku.refAccountCallback = function() {\r\n    try {\r\n      var lykApi = {\r\n        handler: typeof window.external == 'object' ? window.external : {},\r\n        refAccountCallback: function(data) {\r\n          'refAccountCallback' in this.handler && this.handler.refAccountCallback(data);\r\n        },\r\n      };\r\n      window.external.refAccountCallback();\r\n    } catch (error) {\r\n      console.log('方法调用失败');\r\n    }\r\n  };\r\n//检查支付\r\n  function checkPay(jkma, cz_channel, callback, cz_type){\r\n\r\n    clearInterval(loadPay);\r\n    // 轮询\r\n    loadPay = setInterval(function(){\r\n\r\n      // 如果关闭弹窗，结束轮巡\r\n      if(!$(\".pop_pay\").is(':visible')){\r\n        clearInterval(loadPay);\r\n      }\r\n\r\n      $.ajax({\r\n        url: getServiceUrl('/pay/check_pay'),\r\n        type: 'post',\r\n        data:{service: \"ll.order.check\", jkma: jkma, cz_channel: cz_channel},\r\n        xhrFields: {\r\n          withCredentials: true\r\n        },\r\n        success: function(res) {\r\n          // 判断订单支付情况\r\n          if(res.status === 200){\r\n            callback()\r\n            clearInterval(loadPay);\r\n\r\n            // 判断客户端版本，调用不同的方法\r\n            var isTestEnv = window.location.origin.indexOf('test') > -1;\r\n            var minVersionId = isTestEnv ? 660 : 1409;\r\n            liuyunku.getVersionId() > minVersionId\r\n              ? liuyunku.paymentSuccessCallback(res.data)\r\n              : liuyunku.refAccountCallback();\r\n          }else if(res.status === 401){\r\n            if(cz_type !== 3){\r\n              // 二维码过期\r\n              $('.pop_pay .ref .past').html(`<p style=\"width: 100%;position: absolute;top: 50%;left: 50%;transform: translate(-50%, -50%);line-height: 20px; cursor: pointer\" id=\"_userDefine_cover\">二维码已失效<br>点击刷新</p>`).show()\r\n              $('#_userDefine_cover').one(\"click\", function () {\r\n                $('#_payBtn li.active').trigger('click'); // 刷新二维码\r\n              })\r\n              clearInterval(loadPay);\r\n            }\r\n          }\r\n        },\r\n        error: function(err){\r\n          console.log('err:',err)\r\n        }\r\n      })\r\n    },2000)\r\n  }\r\n\r\n// 切换套包的时候清除轮训\r\n  function clearTabCheckPay(){\r\n    $('.pop_pay .ref .past').hide()\r\n    clearInterval(loadPay);\r\n  }\r\n\r\n  return {\r\n    paymentFcun,\r\n    clearTabCheckPay\r\n  }\r\n})()"],"names":["window","_lib_pay","urlFirstString","url","slice","getServiceUrl","arguments","length","undefined","location","origin","indexOf","loadPay","createQrCodes","type","ua","navigator","userAgent","toLowerCase","match","$_qrcode","$","html","unionPay","setTimeout","qrcode","width","height","text","document","getElementById","append","concat","payurl","liuyunku","getVersionId","versionId","external","LiuYunKuVersionId","err","console","log","Number","paymentSuccessCallback","data","lykApi","handler","_typeof","error","hasErr","this","Promise","resolve","reject","catch","refAccountCallback","paymentFcun","params","callback","addClass","show","JSON","stringify","ajax","xhrFields","withCredentials","success","res","status","parseInt","cz_type","empty","jkma","cz_channel","clearInterval","setInterval","is","service","minVersionId","one","trigger","checkPay","order_type","removeClass","hide","easyPop","open","content","msg","clearTabCheckPay"],"mappings":"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"}